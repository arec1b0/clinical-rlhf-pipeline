# Clinical RLHF Pipeline Configuration
# Production-ready config with P0 features

model:
  # Use mock models for demo (set false for real medical LLMs)
  use_mock_models: true
  
  # Medical LLM to use when use_mock_models: false
  # Options: biogpt, biomistral-7b, meditron-7b, openbiollm-8b, medalpaca-7b
  medical_llm: "biomistral-7b"
  
  max_length: 512
  device: "auto"  # auto-detects cuda/mps/cpu

# =============================================================================
# P0.1: Memory Monitoring Configuration
# =============================================================================
memory_monitoring:
  warning_threshold: 0.70      # 70% - trigger GC
  critical_threshold: 0.85     # 85% - clear cache
  emergency_threshold: 0.95    # 95% - raise error (set false for demo)
  check_interval_seconds: 5.0
  auto_gc_on_warning: true
  auto_clear_cache_on_critical: true
  raise_on_emergency: false    # true for production
  leak_detection_enabled: true
  leak_growth_threshold: 0.1   # 10% growth triggers warning

# =============================================================================
# P0.2: Automatic Rollback Configuration  
# =============================================================================
rollback:
  min_safety_score: 0.5       # Rollback if safety drops below
  max_unsafe_ratio: 0.15      # Rollback if unsafe ratio exceeds
  max_kl: 0.1                 # Rollback if KL divergence exceeds
  max_rollbacks_per_epoch: 3  # Emergency stop after N rollbacks
  cooldown_steps: 50          # Steps to wait after rollback
  reduce_lr_on_rollback: true
  lr_reduction_factor: 0.5

# =============================================================================
# P0.3: Hallucination Detection Configuration
# =============================================================================
hallucination_detection:
  data_dir: "data"
  audit_log: "logs/hallucination_audit.jsonl"

# =============================================================================
# Reward Weights
# =============================================================================
reward_weights:
  uncertainty_quantification: 0.25
  guideline_adherence: 0.30
  patient_safety: 0.35
  response_coherence: 0.10

uncertainty:
  mc_dropout_samples: 10
  temperature_scaling: true
  confidence_threshold: 0.7
  overconfidence_penalty: 2.0

# =============================================================================
# Safety Configuration
# =============================================================================
safety:
  red_flag_symptoms:
    - "chest pain"
    - "difficulty breathing"
    - "sudden severe headache"
    - "loss of consciousness"
    - "signs of stroke"
    - "severe allergic reaction"
    - "suicidal ideation"
  
  contraindications_db: "data/contraindications.json"
  hard_safety_threshold: 0.3
  soft_safety_threshold: 0.6
  dosage_validation: true
  dosage_db: "data/medication_dosages.json"

guidelines:
  sources:
    - name: "CDC"
      weight: 0.3
    - name: "WHO"
      weight: 0.25
    - name: "NICE"
      weight: 0.25
    - name: "UpToDate"
      weight: 0.2
  
  embedding_model: "sentence-transformers/all-MiniLM-L6-v2"
  min_adherence_score: 0.5

# =============================================================================
# Training Configuration (Demo settings)
# =============================================================================
training:
  ppo:
    learning_rate: 1.41e-5
    batch_size: 8
    mini_batch_size: 4
    ppo_epochs: 2
    gamma: 0.99
    gae_lambda: 0.95
    clip_range: 0.2
    clip_range_vf: 0.2
    vf_coef: 0.5
    max_grad_norm: 0.5
    target_kl: 10000.0  # High for mock models
  
  total_steps: 100  # Reduced for demo
  eval_frequency: 50
  save_frequency: 50
  max_unsafe_ratio: 0.5  # High for demo with mock models
  
  early_stopping:
    enabled: true
    patience: 5
    min_delta: 0.001

# =============================================================================
# Observability
# =============================================================================
observability:
  mlflow:
    tracking_uri: "http://localhost:5000"
    experiment_name: "clinical-rlhf"
    
  prometheus:
    enabled: true
    port: 8000
    
  logging:
    level: "INFO"
    format: "json"
    
  alerts:
    safety_violation_threshold: 0.1
    reward_degradation_threshold: 0.15

data:
  feedback_collection:
    min_experts_per_sample: 3
    agreement_threshold: 0.7
    
  quality_checks:
    - "duplicate_detection"
    - "label_consistency"
    - "temporal_leakage"
